---
title: "plotMultiverse"
author: "Maurizio"
date: "3 9 2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.height=8)


```



```{r, message=FALSE}
# load packages

if(!require("pacman")){install.packages("pacman")}
p_load(here, R.matlab, stringr, plyr, ggplot2)

```



```{r}
#####################################
# read data

filenames <- list.files(here::here("Results", "Multiverse_Loop"))

# number of repeats and folds
exampleFile <- readMat(here::here("Results", "Multiverse_Loop", filenames[1]))
nRepeats <- length(exampleFile$fullOutputs)
nFolds <- exampleFile$fullOutputs[[1]][[3]]

# loop to load data into df
df <- as.data.frame(matrix(nrow = 0, ncol = 11))

for(i in 1:length(filenames)){
  
  # prepare filename
  filename <- filenames[i]
  filename_noExt <- substr(filename, 1, nchar(filename)-4)
  if(substr(filename_noExt, 1, 11) == "ER_LookDiff"){filename_noExt <- str_replace(filename_noExt, "ER_LookDiff", "ERLookDiff")}
  filename_split <- str_split(filename_noExt, "_", simplify = T)
  
  # load file
  modelResults <- readMat(here::here("Results", "Multiverse_Loop", filename))
  
  for(j in 1:nRepeats){
    
    resultRows <- cbind(matrix(filename_split, nrow=nFolds, ncol=length(filename_split), byrow=TRUE), modelResults$fullOutputs[[j]][[5]], filename_noExt)
    df <- rbind(df, resultRows)
    
  }
  
}
```


```{r}
#####################################
# preprocess data

names(df) <- c("outcome", "data", "contrast", "trainsVsFull", "masking", "rescale", "cv", "algorithm", "cvCorr", "optHyperPar", "modelDescr")

# set negative correlations to 0
df$cvCorr <- as.numeric(ifelse(df$cvCorr < 0, 0, df$cvCorr))

# calculate mean correlation per model (including fisher z transformation)
df <- ddply(df, c("outcome", "data", "contrast", "trainsVsFull", "masking", "rescale", "cv", "algorithm"), transform, meanCorr = tanh(mean(atanh(cvCorr))))

dfMean <- unique(df[, -which(names(df) == "cvCorr" | names(df) == "optHyperPar")])
names(dfMean)[which(names(dfMean) == "meanCorr")] <- "cvCorr"
```


```{r}
# function for multiverse plots

plotMultiverse <- function(outcome){
  
  ggplot(data = df[df$outcome == outcome, ], aes(x = reorder(modelDescr, -cvCorr), y = cvCorr)) +
    geom_point(colour = "lightgrey") +
    geom_point(data = dfMean[dfMean$outcome == outcome, ]) +
    
    geom_hline(yintercept = mean(df[df$outcome == outcome, "cvCorr"]), linetype = "dashed") +
    
    theme_classic() +
    theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1)) +
    
    ggtitle(outcome) + xlab("Model") + ylab("Pattern-Outcome Correlation")
  
}
```


# Notes

Prediction of negative emotionality traits from functional brain data (Task 1: negative [IAPS] scenes, N = 332; Task 2: Negative facial expressions, N = 427). In this document, only CV results from the training set (N - 100) are shown. 

Testing the outcome-wise best model on the hold-out set (N = 100) led only to statistically significant results when predicting the affective self-reports during the IAPS task (r = 0.23, p = 0.02) but not for the remaining outcomes (r < 0.10)

Y-Axis:
Correlation between predicted and actual outcome values. Based on 2x5x5 repeated nested cross-validation for hyperparameter optimization (2 repeats, 5 cv folds, 5 optimization folds)

Dashed Line:
Marks a heuristic threshold for statistical significance, based on a usual exact test for product-moment correlations and the given sample size. This threshold is likely too liberal. An accurate statistical test would would entail permuting the outcome, which (a) leads to different thresholds for each outcome and (b) is computationally prohibitive, at least on our department's machine.

X-Axis:
Modelling and/or preprocessing choice. Models are named in the format: "outcome_dataset_baselineChoice_trainingOrFullSample_masking_standardization_MLmodel"
---dataset: IAPS = scenes, PFA_faces = facial expression
---baselineChoice: Neutral baseline condition or implicit baseline
---trainingOrFullSample: In this document, only results from models built on the training set are shown. Models based on the full data are currently running
---masking: Currently only grey matter masking ('GM'). Potentially. Additionally, using neurosynth masks for the outcome names as keywords might be interesting
---standardization: whether person-wise brain images are (1) raw, (2) centered, (3) z-standardized on their own image-wise statistics
---MLmodel: partials least squares (PLS), principal component regression (PCR), support vector machines (SVM), random forest (oob_rf)
\newpage

## Difference score between affective ratings in the negative and the neutral condition
```{r}
plotMultiverse("ERLookDiff")
```
\newpage


## Neuroticism
```{r}
plotMultiverse("neoN")
```
\newpage


## Negative Affect
```{r}
plotMultiverse("NA")
```
\newpage


## Positive Affect
```{r}
plotMultiverse("PA")
```
\newpage


## Trait Anxiety
```{r}
plotMultiverse("STAI")
```
\newpage


## Beck Depression Inventory
```{r}
plotMultiverse("BDI")
```
\newpage
